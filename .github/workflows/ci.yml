name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - run: go mod tidy
      - run: go vet ./...
      - run: go test -v -race -count=1 ./...
      - run: go build -o cascadeguard .
      - name: Smoke test
        run: |
          cat > /tmp/test-topo.yaml << 'EOF'
          services:
            gw:
              calls:
                - target: api
                  timeout: 3s
                  retries: 3
                  circuit_breaker: false
                  method: GET
            api:
              calls:
                - target: db
                  timeout: 5s
                  retries: 2
                  circuit_breaker: false
                  method: POST
          EOF
          ./cascadeguard /tmp/test-topo.yaml || [ $? -eq 1 ]
